{template 'header'}
{if $action == 'result'}
<div class="m">
	<div class="nav">
		<a href="{$MODULE[1][linkurl]}">首页</a> <i>&gt;</i> <a href="{$MOD[linkurl]}">{$MOD[name]}</a> <i>&gt;</i> <a href="?mid={$mid}">购物车</a>
	</div>
	{if $code < 10}
	<div class="ui-ok">
		<p>商品已成功加入购物车！ </p>
		<input type="button" value="立即结算" class="btn-green" onclick="Go('?mid={$mid}');"/><br/>
		<input type="button" value="返回商品" class="btn" onclick="Go('{$url}');"/>
	</div>
	{else}	
	<div class="ui-ko">
		<p>
		{if $code == 10}
		商品不存在
		{elseif $code == 11}
		商家不存在
		{elseif $code == 12}
		不能下单自己的商品
		{elseif $code == 13}
		商品未上架
		{elseif $code == 14}
		商品库存不足
		{elseif $code == 15}
		商品价格错误
		{else}
		订单提交失败
		{/if}
		</p>
		<input type="button" value="重新挑选" class="btn-green" onclick="Go('{$MOD[linkurl]}');"/><br/>
		{if $itemid}
		<input type="button" value="查看商品" class="btn" onclick="Go('{$url}');"/>
		{else}
		<input type="button" value="返回购物车" class="btn" onclick="Go('cart.php?mid={$mid}');"/>
		{/if}
	</div>
	{/if}
</div>
{else}
<script type="text/javascript">var errimg = '{DT_STATIC}image/nopic60.png';</script>
<div class="m">
	<div class="nav">
		<a href="{$MODULE[1][linkurl]}">首页</a> <i>&gt;</i> <a href="{$MOD[linkurl]}">{$MOD[name]}</a> <i>&gt;</i> <a href="?mid={$mid}">购物车</a>
	</div>
	{if $lists}
	<form method="post" action="buy.php" onsubmit="return Mcheck();">
	<input type="hidden" name="from" value="cart"/>
	<input type="hidden" name="mid" value="{$mid}"/>
	<table cellpadding="16" cellspacing="0" class="tb">
	<tr>
	<th width="20"><input type="checkbox" checked="checked" id="check-all" onclick="Ccheck();calculate();"/></th>
	<th width="70">图片</th>
	<th>商品</th>
	<th width="60">库存</th>
	<th width="60">单价</th>
	<th width="100">数量</th>
	<th width="100">金额</th>
	<th width="60">删除</th>
	</tr>
	{loop $lists $tags}
	{loop $tags $i $t}
	{if $i == 0}
	<tr align="center" bgcolor="#FAFAFA">
	<td><input type="checkbox" checked="checked" id="check-{$t[username]}" onclick="Ccheck('{$t[username]}');calculate();" data-check="{$t[username]}"/></td>
	<td align="left" colspan="3">
	{if $t[vip]}<img src="{DT_SKIN}vip_{$t[vip]}.gif" alt="{VIP}" title="{VIP}:{$t[vip]}级" align="absmiddle"/> {/if}<a href="{userurl($t[username])}" target="_blank">{$t[company]}</a>
	{if $DT[im_web]} &nbsp; {im_web($t[username].'&mid='.$t[mid].'&itemid='.$t[itemid])}{/if}
	{if $t[qq] && $DT[im_qq]} &nbsp; {im_qq($t[qq])}{/if}
	{if $t[wx] && $DT[im_wx]} &nbsp; {im_wx($t[wx], $t[username])}{/if}
	{if $t[ali] && $DT[im_ali]} &nbsp; {im_ali($t[ali])}{/if}
	{if $t[skype] && $DT[im_skype]} &nbsp; {im_skype($t[skype])}</a>{/if}
	</td>
	<td>
	{php $promos = get_promos($t[username]);}
	{if $promos}
	<a href="{$MODULE[2][linkurl]}coupon.php?username={$t[username]}" target="_blank"><div class="cart-promo">优惠券</div></a>
	{/if}
	</td>
	<td></td>
	<td></td>
	<td></td>
	</tr>
	{/if}
	<tr align="center" id="tr_{$t[key]}" class="f_gray">
	<td>
	<input type="checkbox" name="cart[]" value="{$t[key]}"{if $t[valid]} checked="checked" onclick="calculate()"{else}disabled{/if} id="check_{$t[key]}" data-check="{$t[username]}"/>
	<input type="hidden" id="a1_{$t[key]}" value="{$t[a1]}"/>
	<input type="hidden" id="a2_{$t[key]}" value="{$t[a2]}"/>
	<input type="hidden" id="a3_{$t[key]}" value="{$t[a3]}"/>
	<input type="hidden" id="p1_{$t[key]}" value="{$t[p1]}"/>
	<input type="hidden" id="p2_{$t[key]}" value="{$t[p2]}"/>
	<input type="hidden" id="p3_{$t[key]}" value="{$t[p3]}"/>
	<input type="hidden" id="amount_{$t[key]}" value="{$t[amount]}"/>
	<input type="hidden" id="mina_{$t[key]}" value="{$t[mina]}"/>
	<input type="hidden" id="maxa_{$t[key]}" value="{$t[maxa]}"/>
	<input type="hidden" id="unit_{$t[key]}" value="{$t[unit]}"/>
	</td>
	<td><a href="{$t[linkurl]}" target="_blank"><img src="{$t[thumb]}" width="70" alt="{$t[alt]}"  onerror="this.src=errimg;"/></a></td>
	<td align="left">
	<div style="height:40px;line-height:20px;overflow:hidden;"><a href="{$t[linkurl]}" target="_blank" class="b" title="{$t[alt]}">{$t[title]}</a></div>
	<span class="f_grey">{if $t[m1]}{$t[n1]}:{$t[m1]}&nbsp;{/if}{if $t[m2]}{$t[n2]}:{$t[m2]}&nbsp;{/if}{if $t[m3]}{$t[n3]}:{$t[m3]}&nbsp;{/if}</span>
	</td>
	<td>{if $t[amount]>0}{$t[amount]}{$t[unit]}{else}<span class="f_red">库存不足</span>{/if}</td>
	<td title="{if $t[a2]}{$t[a1]}-{$t[a2]}{$t[unit]} {$DT[money_sign]}{$t[p1]}&#10;{if $t[a3]}{$t[a2]+1}-{$t[a3]}{$t[unit]} {$DT[money_sign]}{$t[p2]}&#10;{$t[a3]}{$t[unit]}以上 {$DT[money_sign]}{$t[p3]}{else}{$t[a2]+1}{$t[unit]}以上 {$DT[money_sign]}{$t[p2]}{/if}{else}{$DT[money_sign]}{$t[p1]}{/if}">{$DT[money_sign]}<span id="price_{$t[key]}">{$t[price]}</span></td>
	<td class="f_gray">{if $t[valid]}<img src="{DT_SKIN}arrow_l.gif" width="16" height="8" alt="减少" class="c_p" onclick="alter('{$t[key]}', '-', {$t[mina]}, {$t[maxa]});"/><input type="text" name="amounts[{$t[key]}]" value="{$t[a]}" id="number_{$t[key]}" size="3" onblur="calculate();" class="cc_inp"/> <img src="{DT_SKIN}arrow_r.gif" width="16" height="8" alt="增加" class="c_p" onclick="alter('{$t[key]}', '+', {$t[mina]}, {$t[maxa]});"/>{else}失效{/if}</td>
	<td class="f_price">{$DT[money_sign]}<span id="total_{$t[key]}" total-{$t[username]}="1">{$t[price]}</span></td>
	<td class="c_p" onclick="if(confirm('确定要删除此商品吗？')) move('{$t[key]}');">删除</a></td>
	</tr>
	{/loop}
	{/loop}
	</table>
	<div class="cart-foot">
		<table cellpadding="0" cellspacing="0" width="100%">
		<tr>
		<td valign="top"><a href="javascript:;" onclick="move_muti(0);"><b>删除选中</b></a><a href="javascript:;" onclick="move_muti(1);"><b>移入收藏</b></a><a href="javascript:;" onclick="move_muti(2);"><b>清空商品</b></a></td>
		<td><p>已选商品 <span class="f_red f_b px16" id="total_good"></span> 件&nbsp;&nbsp;&nbsp;&nbsp;合计(不含运费)： <span class="f_red f_b px16">{$DT[money_sign]}</span><span class="f_red f_b px16" id="total_amount"></span></p></td>
		<td width="96"><input type="submit" value="结算"/></td>
		</tr>
		</table>
	</div>
	</form>
	{else}
		<div class="cart-msg">
		<img src="{DT_SKIN}cart_empty.png" width="48" height="48" alt="" align="absmiddle"/> &nbsp; 
		{if $action == 'guest'}
		您还没有登录，请先 <a href="{$DT[file_login]}" class="b">登录</a> 或 <a href="{$DT[file_register]}" class="b">注册</a>
		{elseif $action == 'close'}
		购物车功能未开放
		{else}
		您的 <span class="f_orange">购物车</span> 还是空的，赶快行动吧！马上去 <a href="{$MOD[linkurl]}" class="b">挑选商品</a>
		{/if}
		</div>
	{/if}
</div>
{/if}
<script type="text/javascript">
function Ccheck(key) {
	$(key ? '[data-check="'+key+'"]' : '[data-check]').each(function(){
		$(this).prop('checked', $('#check-'+(key ? key : 'all')).prop('checked') ? true : false);
	});
}
function Mcheck() {
	if(Dd('total_good').innerHTML == '0') {
		Dtoast('最少需要挑选1件商品');
		window.scroll(0, 0);
		return false;
	}
    return true;
}
function move_muti(i) {
	if(i == 2) {
		if(confirm('确定要清空购物车吗？')) {
			Go('?mid={$mid}&action=clear');
		}
		return;
	} else {
		if(Dd('total_good').innerHTML == '0') {
			Dtoast('未选择商品');
			return;
		}
		if(confirm(i ? '确定要将选中商品移入收藏吗？' : '确定要删除选中商品吗？')) {
			var par = 'action=delete&mid={$mid}&ajax=1&fav='+i;
			$(':checked').each(function(i) {
				if($(this).attr('id').indexOf('check_') != -1) {
					par += '&key[]='+$(this).val();
				}
			});
			$.post('?', par, function(data) {
				Go('?mid={$mid}&rand={$DT_TIME}');
			});
		}
	}
}
function move(i) {
	Dd('check_'+i).checked = false;
	Dd('check_'+i).disabled = true;
	Dh('tr_'+i);
	calculate();
	$.post('?', 'action=delete&mid={$mid}&ajax=1&key='+i, function(data) {
		var cart_num = get_cart();
		$('#destoon_cart').html(cart_num > 0 ? '<strong>'+cart_num+'</strong>' : '0');
		if(data == 1 && Dd('total_good').innerHTML == '0') Go('?mid={$mid}&rand={$DT_TIME}');
	});
}
function alter(i, t, mina, maxa) {
	if(t == '+') {
		if(maxa && Dd('number_'+i).value >= maxa) {Dtoast('最多购买'+maxa+Dd('unit_'+i).value);return;}
		Dd('number_'+i).value =  parseInt(Dd('number_'+i).value) + 1;
	} else {
		if(Dd('number_'+i).value <= mina) {Dtoast('最少购买'+mina+Dd('unit_'+i).value);return;}
		Dd('number_'+i).value = parseInt(Dd('number_'+i).value) - 1;
	}
	calculate();
}
function get_price(i) {
	if(Dd('a2_'+i).value > 0) {
		if(Dd('a3_'+i).value > 1 && parseInt(Dd('number_'+i).value) > parseInt(Dd('a3_'+i).value)) return Dd('p3_'+i).value;
		if(Dd('a2_'+i).value > 1 && parseInt(Dd('number_'+i).value) > parseInt(Dd('a2_'+i).value)) return Dd('p2_'+i).value;
		return Dd('p1_'+i).value;
	}
	return Dd('p1_'+i).value
}
function calculate() {
	var _good = _amount = _total = 0;
	$(':checked').each(function(i) {
		if($(this).attr('id').indexOf('check_') != -1) {
			var key = $(this).val();
			var num, good, maxa, mina, price;
			num = parseInt(Dd('number_'+key).value);
			maxa = parseInt(Dd('maxa_'+key).value);
			mina = parseInt(Dd('mina_'+key).value);
			if(num < mina) Dd('number_'+key).value = num = mina;
			if(num > maxa) Dd('number_'+key).value = num = maxa;
			if(isNaN(num) || num < 0) Dd('number_'+key).value = num = mina;
			_good++;
			price = parseFloat(get_price(key));
			_total = price*num;
			_amount += _total;
			Dd('price_'+key).innerHTML = price.toFixed(2);
			Dd('total_'+key).innerHTML = _total.toFixed(2);
		}
	});
	Dd('total_good').innerHTML = _good;
	Dd('total_amount').innerHTML = _amount.toFixed(2);
}
{if $lists}$(function(){calculate();});{/if}
</script>
{template 'footer'}