{template 'header', 'member'}
<div class="menu">
<table cellpadding="0" cellspacing="0">
<tr>
<td class="tab" id="add"><a href="?action=add"><span>新增优惠</span></a></td>
<td class="tab" id="s3"><a href="?action=index"><span>优惠促销</span></a></td>
<td class="tab" id="coupon"><a href="?action=coupon"><span>领券记录</span></a></td>
</tr>
</table>
</div>
{if $action=='add' || $action=='edit'}
<form method="post" action="?" id="dform" onsubmit="return check();">
<input type="hidden" name="action" value="{$action}"/>
<input type="hidden" name="itemid" value="{$itemid}"/>
<input type="hidden" name="forward" value="{$forward}"/>
<table cellpadding="10" cellspacing="1" class="tb">
<tr>
<td class="tl"><span class="f_red">*</span> 优惠名称</td>
<td class="tr"><input name="post[title]" type="text" id="title" size="20" value="{$title}" /> <span class="f_gray">例如满减、店庆</span> <span id="dtitle" class="f_red"></span></td>
</tr>
<tr>
<td class="tl"><span class="f_red">*</span> 优惠金额</td>
<td class="tr"><input name="post[price]" type="text" id="price" size="20" value="{$price}" /> <span id="dprice" class="f_red"></span></td>
</tr>
<tr>
<td class="tl">最低消费</td>
<td class="tr"><input name="post[cost]" type="text" id="cost" size="20" value="{$cost}"/> <span class="f_gray">0.00代表不限制</span></td>
</tr>
<tr>
<td class="tl"><span class="f_red">*</span> 数量限制</td>
<td class="tr"><input name="post[amount]" type="text" id="amount" size="20" value="{$amount}"/> <span id="damount" class="f_red"></span></td>
</tr>
<tr>
<td class="tl"><span class="f_red">*</span> 有效时间</td>
<td class="tr">{dcalendar('post[fromtime]', $fromtime, '-', 1)} 至 {dcalendar('post[totime]', $totime, '-', 1)} <span id="dtime" class="f_red"></span></td>
</tr>
<tr>
<td class="tl">频道限制</td>
<td class="tr">
<select name="post[mid]" id="mid" onchange="loadc(this.value);">
<option value="0">不限</option>
{loop $MODULE $m}
{if $m[module] == 'mall'}<option value="{$m[moduleid]}"{if $mid==$m[moduleid]} selected{/if}>{$m[name]}</option>{/if}
{/loop}
</select> <span id="dmid" class="f_red"></span>
</td>
</tr>
<tr>
<td class="tl">类目限制</td>
<td class="tr">{ajax_category_select('post[catid]', '不限', $catid, $cmid)}</td>
</tr>
<tr>
<td class="tl">指定商品</td>
<td class="tr"><input name="post[itemids]" type="text" id="itemids" size="70" value="{$itemids}"/> &nbsp; <img src="{DT_STATIC}image/ico-sort.png" width="11" height="11" title="选择商品" class="c_p" onclick="if(Dd('mid').value>0){select_item(Dd('mid').value, 'promo');}else{Dmsg('请选择频道', 'mid');}"/> &nbsp; <span class="f_gray">填写商品ID，多个ID用英文逗号隔开，例如1,2,3</span></td>
</tr>
<tr>
<td class="tl">备注信息</td>
<td class="tr"><input name="post[note]" type="text" id="note" size="70" value="{$note}"/> <span id="dnote" class="f_red"></span></td>
</tr>
</table>
<div class="sbt"><input type="submit" name="submit" value="{if $action=='add'}添 加{else}修 改{/if}" class="btn_g"/></div>
</form>
<script type="text/javascript">s('promo');m({if $action=='add'}'add'{else}'s3'{/if});</script>
{elseif $action == 'coupon'}
<div class="ls">
<table cellpadding="10" cellspacing="0" class="tb">
<tr>
<th>优惠名称</th>
<th>会员</th>
<th>金额</th>
<th>最低消费</th>
<th>生效时间</th>
<th>结束时间</th>
<th>领券时间</th>
<th width="60">订单</th>
<th width="60">状态</th>
</tr>
{loop $lists $k $v}
<tr align="center">
<td{if $v[note]} title="备注:{$v[note]}"{/if}>{$v[title]}</td>
<td><a href="?action={$action}&username={$v[username]}" class="t">{$v[username]}</a></td>
<td>{$DT[money_sign]}{$v[price]}</td>
<td>{$DT[money_sign]}{$v[cost]}</td>
<td class="f_gray">{timetodate($v[fromtime], 5)}</td>
<td class="f_gray">{timetodate($v[totime], 5)}</td>
<td class="f_gray">{timetodate($v[addtime], 5)}</td>
<td>{if $v[oid]}<a href="trade.php?action=update&step=detail&itemid={$v[oid]}" target="_blank" class="t">{$v[oid]}</a>{/if}</td>
<td>
{if $v[oid]}
<span class="f_green">已使用</span>
{elseif $v[fromtime] > $DT_TIME}
<span class="f_gray">未开始</span>
{elseif $v[totime] < $DT_TIME}
<span class="f_red">已过期</span>
{else}
<span class="f_blue">待使用</span>
{/if}
</td>
</tr>
{/loop}
</table>
</div>
<div class="pages">{$pages}</div>
<script type="text/javascript">s('promo');m('coupon');</script>
{else}
<form method="post">
<div class="ls">
<table cellpadding="10" cellspacing="0" class="tb">
<tr>
<th width="20"><input type="checkbox" onclick="checkall(this.form);" title="全选/反选"/></th>
<th>优惠名称</th>
<th>金额</th>
<th>最低消费</th>
<th>数量限制</th>
<th>领券人数</th>
<th>生效时间</th>
<th>结束时间</th>
<th>状态</th>
<th data-hide-1200="1">添加时间</th>
<th width="120">领券链接</th>
{if strpos($DT_MBS, 'IE') === false}<th width="20"></th>{/if}
<th width="40">修改</th>
</tr>
{loop $lists $k $v}
<tr align="center">
<td><input type="checkbox" name="itemid[]" value="{$v[itemid]}"/></td>
<td{if $v[note]} title="备注:{$v[note]}"{/if}><a href="?action=coupon&itemid={$v[itemid]}" class="t">{$v[title]}</a></td>
<td>{$DT[money_sign]}{$v[price]}</td>
<td>{$DT[money_sign]}{$v[cost]}</td>
<td>{$v[amount]}</td>
<td><a href="?action=coupon&pid={$v[itemid]}" class="t">{$v[number]}</a></td>
<td class="f_gray">{timetodate($v[fromtime], 5)}</td>
<td class="f_gray">{timetodate($v[totime], 5)}</td>
<td>{$L[process][$v[process]]}</td>
<td data-hide-1200="1" class="f_gray">{timetodate($v[addtime], 5)}</td>
<td><input style="width:100px;" value="{$MODULE[2][linkurl]}coupon.php?itemid={$v[itemid]}" id="copy-{$v[itemid]}"/></td>
{if strpos($DT_MBS, 'IE') === false}<td><img src="{DT_STATIC}image/ico-copy.png" class="cp" title="复制" data-clipboard-action="copy" data-clipboard-target="#copy-{$v[itemid]}" onclick="Dtoast('{$v[title]}领券链接已复制');"/></td>{/if}
<td><a href="?action=edit&itemid={$v[itemid]}"><img width="16" height="16" src="{DT_STATIC}member/edit.png" title="修改" alt=""/></a></td>
</tr>
{/loop}
</table>
</div>
<div class="btns">
<label><input type="checkbox" onclick="checkall(this.form);" title="全选/反选"/></label>
<input type="submit" value=" 删除选中 " class="btn_r" onclick="if(confirm('确定要删除选中优惠吗？')){this.form.action='?action=delete'}else{return false;}"/>
</div>
</form>
{if $MG[promo_limit]}
<div class="limit">总共可加 <span class="f_b f_red">{$MG[promo_limit]}</span> 条&nbsp;&nbsp;&nbsp;当前已加 <span class="f_b">{$limit_used}</span> 条&nbsp;&nbsp;&nbsp;还可以加 <span class="f_b f_blue">{$limit_free}</span> 条</div>
{/if}
<div class="pages">{$pages}</div>
{if strpos($DT_MBS, 'IE') === false}
{load('clipboard.min.js')}
<script type="text/javascript">var clipboard = new Clipboard('[data-clipboard-action]');</script>
{/if}
<script type="text/javascript">
s('promo');m('s3');
</script>
{/if}
{if $action=='add' || $action=='edit'}
<script type="text/javascript">
function check() {
	var f;
	var l;
	f = 'title';
	l = Dd(f).value.length;
	if(l < 2) {
		Dmsg('请填写优惠名称', f);
		return false;
	}
	f = 'price';
	l = parseFloat(Dd(f).value);
	if(!l || l < 0.01) {
		Dmsg('请填写优惠金额', f);
		return false;
	}
	f = 'amount';
	l = parseInt(Dd(f).value);
	if(!l || l < 1) {
		Dmsg('请填写数量限制', f);
		return false;
	}
	l = Dd('postfromtime').value.length;
	if(l != 19) {
		Dmsg('请选择开始时间', 'time');
		return false;
	}
	l = Dd('posttotime').value.length;
	if(l != 19) {
		Dmsg('请选择结束时间', 'time');
		return false;
	}
	return true;
}
function loadc(i) {
	if(i) {
		category_moduleid[1] = i;
		load_category(0, 1);
	}
}
</script>
{/if}
{template 'footer', 'member'}