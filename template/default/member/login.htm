{template 'header'}
<div class="b10"></div>
<div class="m" style="padding:32px 0;">
	<div class="login-show"><!--[左侧广告位]-->&nbsp;</div>
	<div class="login-main">
		<div id="msgs"></div>
		<div class="login-head">
			<ul>
			{if $action=='child'}
			<li class="on"><a href="?action=child">子账号登录</a></li>
			<li><a href="?action=login">账号登录</a></li>
			{else}
			<li{if $action=='login'} class="on"{/if}><a href="?action=login">账号登录</a></li>
			{if $could_sms}<li{if $action=='sms'} class="on"{/if}><a href="?action=sms">短信登录</a></li>{/if}
			{if $could_weixin}<li{if $action=='weixin'} class="on"{/if}><a href="?action=weixin">微信扫码</a></li>{/if}
			{if $could_scan}<li{if $action=='scan'} class="on"{/if}><a href="?action=scan">扫码登录</a></li>{/if}
			{/if}
			</ul>
		</div>
		<div class="login-body">
			{if $action == 'weixin'}
			{if WX_ID == 'gzh'}
			<div><iframe src="{DT_PATH}api/weixin/qrcode_login.php?action=scan" style="width:100%;height:400px;" scrolling="no" frameborder="0"></iframe></div>
			{else}
			<div><div id="weixin_qrcode"></div></div>
			<script src="//res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js?v={if DT_DEBUG}{DT_TIME}{else}{DT_REFRESH}{/if}"></script>
			<script type="text/javascript">
			var obj = new WxLogin({
				id:"weixin_qrcode", 
				appid: "{OAUTH_ID}", 
				scope: "snsapi_login", 
				redirect_uri: "{urlencode(OAUTH_CALLBACK)}",
				state: "",
				style: "",
				href: "{DT_PATH}api/oauth/wechat/style.css?v={if DT_DEBUG}{DT_TIME}{else}{DT_REFRESH}{/if}"
			});
			</script>
			{/if}			
			<div class="t_c" id="agree"></div>
			{elseif $action == 'scan'}
			<div class="t_c">
			<div><img src="{DT_PATH}api/qrcode.php?auth={$auth}" width="240" id="qrlogin" onclick="window.location.reload();"/></div>
			<div style="padding:24px 0;font-size:12px;color:#666666;" id="tips">打开<a href="{DT_PATH}api/mobile.php" target="blank" class="b">手机APP</a>，扫描二维码</div>	
			</div>		
			<div class="t_c" id="agree"></div>
			<script type="text/javascript">
			function Sload() {
				$.get('?action=scan&job=ajax', function(data) {
					if(data == 'ok') {
						$('#tips').html('<span class="f_green">登录成功，正在返回</span>');
						Go('{$forward}');
						clearInterval(scan_interval);
					} else if(data == 'scan') {
						$('#tips').html('<span class="f_green">扫描成功</span>，请按手机端提示操作');
					} else if(data == 'ko') {
						$('#tips').html('<span class="f_red">登录失败</span>，请 <a href="javascript:;" onclick="window.location.reload();" class="b">刷新</a> 页面重试');
						$('#qrlogin').css('opacity', '0.05');
						clearInterval(scan_interval);
					} else if(data == 'out') {
						$('#tips').html('<span class="f_red">二维码失效</span>，请 <a href="javascript:;" onclick="window.location.reload();" class="b">刷新</a> 页面重试');
						$('#qrlogin').css('opacity', '0.05');
						clearInterval(scan_interval);
					}
				});
			}
			$(function() {
				var scan_interval = window.setInterval(
					function() {
						Sload();
					}, 
				1000);
			});	
			</script>
			{elseif $action == 'sms'}
			<form method="post" action="?" onsubmit="return Scheck();">
			<input type="hidden" name="action" value="{$action}"/>
			{if $verfiy}<div style="font-size:12px;color:#FF6600;">&nbsp;本次登录需要使用手机短信验证身份</div>{/if}
			<div><input name="mobile" type="text" id="mobile"{if $verfiy} value="{$mobile}" readonly{/if} placeholder="已认证手机号" class="input-mob"/></div>
			<div>{template 'captcha', 'chip'}</div>
			<div><input name="code" type="text" id="code" placeholder="短信验证码" class="input-code"/> &nbsp; <a href="javascript:;" class="b" onclick="Dsend();" id="send">获取短信验证码</a></div>
			<div><input type="submit" name="submit" value="登 录" class="btn-blue login-btn"/></div>			
			<div class="t_c" id="agree"></div>
			</form>
			{elseif $action == 'child'}
			<form method="post" action="?" onsubmit="return Dcheck();">
			<input type="hidden" name="action" value="{$action}"/>
			<div><input name="username" type="text" id="username" value="{$username}" placeholder="用户名" class="input-user"/></div>
			<div><input name="password" type="password" id="password" value="" placeholder="密码"  class="input-pass"/></div>
			{if $MOD[captcha_login]}<div>{template 'captcha', 'chip'}</div>{/if}
			<div><input type="submit" name="submit" value="登 录" class="btn-blue login-btn"/></div>	
			<div class="t_c" id="agree"></div>	
			</form>
			{else}
			<form method="post" action="?" onsubmit="return Dcheck();">
			<input type="hidden" name="action" value="{$action}"/>
			<input type="hidden" name="auth" value="{$auth}"/>
			<div><input name="username" type="text" id="username" value="{$username}" placeholder="用户名/昵称/手机/邮箱" class="input-user"/></div>
			<div><input name="password" type="password" id="password" value="" placeholder="密码"  class="input-pass"/></div>
			{if $MOD[captcha_login]}<div>{template 'captcha', 'chip'}</div>{/if}
			<div><input type="submit" name="submit" value="登 录" class="btn-blue login-btn"/></div>
			<div class="t_c" id="agree"></div>
			<div class="t_c"><span class="f_gray"><a href="{$DT[file_register]}" class="b">会员注册</a> &nbsp;|&nbsp; <a href="send.php" class="b">忘记密码</a>
			{if $could_child} &nbsp;|&nbsp; <a href="?action=child" class="b">子账号登录</a>{/if}</span></div>
			{if $oa}
			<div title="使用社交帐号登录" class="login-oauth">		
			{loop $OAUTH $k $v}
			{if $v[enable]}<a href="{DT_PATH}api/oauth/{$k}/connect.php" title="{$v[name]}"><img src="{DT_PATH}api/oauth/{$k}/icon.png" alt="{$v[name]}"/></a>{/if}
			{/loop}		
			</div>
			{/if}
			</form>
			{/if}
		</div>
	</div>
	<div class="login-show"><!--[右侧广告位]-->&nbsp;</div>
	<div class="c_b"></div>
</div>
<script type="text/javascript">
function Dmsgs(msg) {
	$('#msgs').html(msg);
	$('#msgs').fadeIn(100, function() {
		setTimeout(function() {$('#msgs').fadeOut(300);}, 3000);
	});
}
function Dcheck() {
	if(Dd('username').value.length < 2) {
		Dmsgs('请输入登录名称');
		Dd('username').focus();
		return false;
	}
	if(Dd('password').value.length < 6) {
		Dmsgs('请输入密码');
		Dd('password').focus();
		return false;
	}
{if $DT[md5_pass]}
	if(Dd('password').value.length < 32) Dd('password').value = hex_md5(Dd('password').value);
{/if}
{if $MOD[captcha_login]}
	if($('#ccaptcha').html().indexOf('ok.png') == -1) {
		Dmsgs('请填写验证码');
		Dd('captcha').focus();
		return false;
	}
{/if}
	return true;
}
function Scheck() {
	if(Dd('mobile').value.length < 11) {
		Dmsgs('请输入手机号码');
		Dd('mobile').focus();
		return false;
	}
	if(Dd('code').value.length < 6) {
		Dmsgs('请输入短信验证码');
		Dd('code').focus();
		return false;
	}
	return true;
}
function Dstop() {
	var i = 60;
	var interval=window.setInterval(
		function() {
			if(i < 1) {
				$('#send').html('重新获取');
				clearInterval(interval);
			} else {
				$('#send').html(i+'秒后重新获取');
				i--;
			}
		},
	1000);
}
function Dsend() {
	if($('#send').html().indexOf('秒') != -1) {
		Dmsgs('请稍后重新获取');
		return false;
	}
	if(Dd('mobile').value.length < 11) {
		Dmsgs('请输入手机号码');
		Dd('mobile').focus();
		return false;
	}
	if($('#ccaptcha').html().indexOf('ok.png') == -1) {
		Dmsgs('验证码填写错误');
		Dd('captcha').focus();
		return false;
	}
	Dtoast('发送中..');
	$.post('?', 'action=send&mobile='+Dd('mobile').value+'&captcha='+Dd('captcha').value, function(data) {
		if(data == 'ok') {
			Dtoast('短信验证码发送成功');
			Dstop();return;
		} else if(data == 'format') {
			Dmsgs('手机格式错误');
		} else if(data == 'captcha') {
			Dmsgs('验证码错误');
		} else if(data == 'exist') {
			Dmsgs('号码不存在或未验证');
		} else if(data == 'max') {
			Dmsgs('发送次数过多');
		} else if(data == 'fast') {
			Dmsgs('发送频率过快');
		} else {
			Dmsgs('发送失败'+data);
		}
		reloadcaptcha();
	});
}
$(function(){
	if($('.login-head li').length == 2) {
		$('.login-head li').css('width', '50%');
	} else if($('.login-head li').length == 4) {
		$('.login-head li').css('width', '25%');
	}
	{if $action == 'sms' && $MOD[login_sms] == 2}
	$('#agree').html('<span class="px12 f_gray">未注册的手机号将自动注册，注册代表您已阅读并同意 <a href="{DT_MOB}about/agreement.html" class="b">用户协议</a> 和 <a href="{DT_MOB}about/privacy.html" class="b">隐私政策</a><br/></span>');
	{else}
	$('#agree').hide();
	{/if}

});
</script>
{if $DT[md5_pass]}{load('md5.js')}<script type="text/javascript">$(function(){md5_pwd();});</script>{/if}
{template 'footer'}