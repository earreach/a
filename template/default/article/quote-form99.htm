{template 'header'}

<h2>设备故障确认 & 报价信息填写</h2>

<form action="{$MOD[linkurl]}quote.php" method="post" enctype="multipart/form-data" id="quote-form">
  <input type="hidden" name="step" value="submit"/>
  <input type="hidden" name="devices_detail" value="{php echo htmlspecialchars($devices_detail_json, ENT_QUOTES, 'UTF-8');}"/>
  <input type="hidden" name="model_catids" value="{$model_catids_str}"/>

  <!-- 1. 设备 & 故障确认 -->
  <h3>1. 确认您选择的设备和故障</h3>
  <div class="quote-devices">
    {loop $devices $catid $d}
    <div class="device-block">
      <h4>设备：{$d['name']} (catid: {$catid})</h4>
      <ul>
        {loop $d['faults'] $f}
        <li>
          故障编号：{$f['num']}，
          故障名称：{$f['name']}，
          参考价格：{$f['price']} 円
        </li>
        {/loop}
      </ul>

      {if $color_options[$catid]}
      <div class="color-select">
        颜色：
        {loop $color_options[$catid] $c}
        <label>
          <input type="radio" name="color" value="{$c}"/> {$c}
        </label>
        {/loop}
      </div>
      {/if}
    </div>
    {/loop}
  </div>


  <!-- 6. 多图上传（上传成功后预览，可删除） -->
  <h3>6. 上传设备照片（可多张）</h3>
  <div id="image-uploader">
    <button type="button" id="btn-select-images">选择图片</button>
    <input type="file" id="image-input" multiple accept="image/*" style="display:none;">
  </div>
  <div id="image-preview-list">
    <!-- 每张图片一块：img + 删除按钮 + hidden input[name="images[]"] -->
  </div>


  <!-- 5. 故障补充说明 -->
  <h3>5. 故障补充说明</h3>
  <div class="form-row">
    <textarea name="fault_desc" rows="4" style="width:100%;" placeholder="请尽量详细描述故障现象（如是否进水、是否自行拆机等）"></textarea>
  </div>


  <!-- 2. 选择维修门店 -->
  <h3>2. 选择维修门店</h3>
  <div class="company-list">
    {loop $companies $c}
    <div class="company-card">
      <label>
        <input type="radio" name="company_id" value="{$c['userid']}"/>
        {$c['company']}
      </label>

      <!-- 地区分级换行 + 缩进 -->
      <div class="company-area">
        {php $area_text = area_pos($c['areaid'], ' / ');}
        {php $area_parts = explode(' / ', $area_text);}
        {if $area_parts[0]}<div class="area-level-1">{$area_parts[0]}</div>{/if}
        {if $area_parts[1]}<div class="area-level-2">{$area_parts[1]}</div>{/if}
        {if $area_parts[2]}<div class="area-level-3">{$area_parts[2]}</div>{/if}
      </div>

      {if $c['thumb']}
      <div class="company-thumb">
        <img src="{$c['thumb']}" alt="{$c['company']}" style="max-width:100px;max-height:100px;"/>
      </div>
      {/if}

      <!-- 公司详情按钮，调用接口，不跳转 -->
      <button type="button" class="btn-company-detail" data-userid="{$c['userid']}">查看详情</button>
    </div>
    {/loop}
  </div>

  <!-- 公司详情弹窗 -->
  <div id="company-modal" style="display:none;">
    <div class="company-modal-mask"></div>
    <div class="company-modal-dialog">
      <span class="company-modal-close">×</span>
      <div id="company-modal-body">加载中...</div>
    </div>
  </div>

  <!-- 3. 预约时间（放在公司下面） -->
  <h3>3. 预约到店时间</h3>
  <div class="form-row">
    <label>日期：</label>
    <input type="date" name="appoint_date"/>
  </div>
  <div class="form-row">
    <label>时间：</label>
    <select name="appoint_hour">
      {php for($h=10;$h<=22;$h++) { }
      <option value="{$h}">{$h}:00</option>
      {php } }
    </select>
  </div>

  <!-- 4. 优惠码（在预约时间下面） -->
  <h3>4. 优惠码</h3>
  <div class="form-row">
    <input type="text" name="discount_code" placeholder="如有优惠码请填写，没有可留空"/>
  </div>



  <!-- 8. 联系人信息（最后） -->
  <h3>8. 联系人信息</h3>
  <div class="form-row">
    <label>姓（必填）：</label>
    <input type="text" name="first_name" required>
  </div>
  <div class="form-row">
    <label>名（必填）：</label>
    <input type="text" name="last_name" required>
  </div>

  <!-- 7. 联系方式 & 验证 -->
  <h3>7. 联系方式 & 验证</h3>

  <!-- 电话：只填写和入库，不发验证码 -->
  <div class="form-row">
    <label>电话号码（选填）：</label>
    <input type="text" name="mobile" id="mobile-input" style="width:300px;" placeholder="可填写联系电话，方便联系">
  </div>

  <!-- 邮箱：必须填写，用来收验证码 -->
  <div class="form-row">
    <label>邮箱（必填）：</label>
    <input type="text" name="email" id="email-input" style="width:300px;" placeholder="请输入邮箱地址，用于接收验证码">
    &nbsp;
    <button type="button" id="btn-send-email-code">获取邮箱验证码</button>
  </div>

  <!-- 邮箱验证码输入框 -->
  <div class="form-row">
    <label>邮箱验证码：</label>
    <input type="text" name="email_code" id="email-code-input" style="width:150px;" placeholder="请输入邮件中的6位验证码">
  </div>

  <!-- 图片验证码：只在提交报价时校验，不参与“获取邮箱验证码” -->
  <div class="form-row">
    <label>图片验证码：</label>
    <!-- 这里用 Destoon 自带的验证码片段 -->
    <!--{template 'captcha', 'chip'}-->
  </div>

  <!-- 提交按钮 -->
  <div class="form-row">
    <button type="submit">提交报价请求</button>
  </div>

</form>

<style>
  .form-row { margin:8px 0; }
  .company-card { border:1px solid #ddd; padding:10px; margin-bottom:10px; }
  .company-area .area-level-1 { margin-left:0; }
  .company-area .area-level-2 { margin-left:1em; }
  .company-area .area-level-3 { margin-left:2em; }

  #company-modal {
    position:fixed; left:0; top:0; right:0; bottom:0;
    z-index:9999;
  }
  .company-modal-mask {
    position:absolute; left:0; top:0; right:0; bottom:0;
    background:rgba(0,0,0,.5);
  }
  .company-modal-dialog {
    position:absolute; left:50%; top:50%;
    transform:translate(-50%, -50%);
    background:#fff; padding:15px; max-width:800px; width:90%; max-height:90%; overflow:auto;
  }
  .company-modal-close { float:right; cursor:pointer; font-size:20px; }
  #image-preview-list { margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; }
  .image-item { border:1px solid #ddd; padding:5px; position:relative; }
  .image-item img { max-width:120px; max-height:120px; display:block; }
  .image-item button { position:absolute; right:2px; top:2px; }
</style>

<script>
  // ======== 公司详情弹窗：调用接口 get_company_detail.php ========
  document.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById('company-modal');
    var modalBody = document.getElementById('company-modal-body');
    var modalClose = document.querySelector('.company-modal-close');
    var modalMask = document.querySelector('.company-modal-mask');

    document.querySelectorAll('.btn-company-detail').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var userid = this.getAttribute('data-userid');
        modal.style.display = 'block';
        modalBody.innerHTML = '加载中...';

        fetch('/api/get_company_detail.php?userid=' + encodeURIComponent(userid))
                .then(function(res){ return res.text(); })
                .then(function(html){
                  modalBody.innerHTML = html;
                })
                .catch(function(){
                  modalBody.innerHTML = '加载失败，请稍后重试';
                });
      });
    });

    function closeModal() {
      modal.style.display = 'none';
    }
    modalClose.addEventListener('click', closeModal);
    modalMask.addEventListener('click', closeModal);
  });

  // ======== 多图上传：上传成功后预览 + 删除 ========
  document.addEventListener('DOMContentLoaded', function() {
    var btnSelect = document.getElementById('btn-select-images');
    var inputFile = document.getElementById('image-input');
    var previewList = document.getElementById('image-preview-list');

    btnSelect.addEventListener('click', function() {
      inputFile.click();
    });

    inputFile.addEventListener('change', function() {
      if(!this.files.length) return;

      Array.prototype.forEach.call(this.files, function(file){
        var formData = new FormData();
        formData.append('file', file);


        fetch('/api/quote_upload_image.php', {
          method: 'POST',
          body: formData
        }).then(function(res){
          return res.text();
        }).then(function(text){
          console.log('服务器返回原文:', text);

          // 先试着解析 JSON
          var data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            alert('服务器返回的不是合法 JSON：\n' + text);
            return;
          }

          if(!data.success) {
            alert(data.message || '上传失败');
            return;
          }

          addImagePreview(data.url, data.path);
        }).catch(function(err){
          alert('请求失败，请稍后再试');
          console.log('fetch 错误:', err);
        });


      });

      // 清空 input，避免同一个文件无法再次触发 change
      this.value = '';
    });

    function addImagePreview(url, path) {
      var item = document.createElement('div');
      item.className = 'image-item';
      item.innerHTML = ''
              + '<img src="'+url+'" alt="">'
              + '<button type="button">删除</button>'
              + '<input type="hidden" name="images[]" value="'+path+'">';
      var btnDel = item.querySelector('button');
      btnDel.addEventListener('click', function(){
        // 这里可以考虑再发请求给后端删除这个文件（可选）
        item.remove();
      });
      previewList.appendChild(item);
    }
  });



</script>
<script>
  // 发送邮箱验证码
  // 发送邮箱验证码（不再需要图片验证码）
  document.addEventListener('DOMContentLoaded', function () {
    var btnSend = document.getElementById('btn-send-email-code');
    if (!btnSend) return;

    btnSend.addEventListener('click', function () {
      var emailInput = document.getElementById('email-input');
      var email = emailInput ? emailInput.value.replace(/\s+/g, '') : '';

      if (!email) {
        alert('请先填写邮箱地址');
        if (emailInput) emailInput.focus();
        return;
      }

      // 简单邮箱格式校验
      var emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailReg.test(email)) {
        alert('邮箱格式不正确');
        if (emailInput) emailInput.focus();
        return;
      }

      // 发送请求到后端接口（只带 email）
      var params = 'email=' + encodeURIComponent(email);

      fetch('/api/quote_send_email_code.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: params
      }).then(function (res) {
        return res.text();
      }).then(function (text) {
        console.log('发送邮箱验证码返回：', text);
        var data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          alert('服务器返回异常：\n' + text);
          return;
        }
        if (!data.success) {
          alert(data.message || '发送失败');
          return;
        }
        alert(data.message || '验证码已发送，请查收邮箱');
      }).catch(function (err) {
        console.log('fetch 错误:', err);
        alert('请求失败，请稍后再试');
      });
    });
  });

  document.addEventListener('DOMContentLoaded', function () {
    var f = document.getElementById('quote-form');
    if (!f) return;

    f.addEventListener('submit', function () {
      alert('正在提交表单（前端 submit 事件已触发）');
    });
  });



</script>

{template 'footer'}
