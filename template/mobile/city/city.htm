{template 'header'}
<div id="head-bar">
<div class="head-bar">
<div class="head-bar-back"><a href="{if $back_link}{$back_link}{else}javascript:Dback();" id="back-{$js_pageid}{/if}" data-direction="reverse"><img src="{DM_SKIN}icon-back{$wh}.png" width="24" height="24"/></a></div>
<div class="head-bar-title">{$city_name}</div>
<div class="head-bar-right">
{if $cityid}
<span onclick="Dc(-1);">全国</span>
{else}
<span onclick="Dc(-2);">智能</span>
{/if}
</div>
</div>
<div class="head-bar-fix" id="load-fix-{$js_pageid}" style="height:0;"></div>
<div class="head-bar-fix" id="head-fix-{$js_pageid}"></div>
</div>

<div class="main">
<div class="ui-form-search">
<div><input type="search" id="kw-{$js_pageid}" maxlength="20" placeholder="{$L[kw]}"/></div>
</div>

{if $my_city}
<a {if $my_city[domain]}href="{$my_city[linkurl]}" rel="external"{else}href="javascript:;" onclick="Dc({$my_city[areaid]});"{/if}><div style="height:42px;line-height:42px;background:#F6F6F6 url('{DM_SKIN}ico-area.png') no-repeat 16px center;background-size:16px 16px;padding:0 0 0 36px;color:#999999;"><span class="ui-fr ui-ico-none" style="background:url('{DM_SKIN}ico-swc.png') no-repeat 0 center;background-size:16px 16px;margin:13px 6px 0 0">立即切换</span>您可能在：{$my_city[name]}</div></a>
{/if}

<div id="list-{$js_pageid}"></div>
<div id="city-{$js_pageid}">
{loop $lists $k $v}
<div style="padding:0 16px;height:24px;line-height:24px;font-size:16px;">{$k}</div>
<div class="list-set">
<ul>
{loop $v $j $s}
<li><a {if $s[domain]}href="{$s[linkurl]" rel="external"{else}href="javascript:;" onclick="Dc({$s[areaid]});"{/if}><div>{$s[name]}</div></a></li>
{/loop}
</ul>
</div>
{/loop}
</div>
</div>
<script type="text/javascript">
$(function(){
	$('#kw-{$js_pageid}').on('input paste', Ds);
	$('#kw-{$js_pageid}').on('blur', function(){window.scrollTo(0,0);});
});
function Ds() {
	var kw = $('#kw-{$js_pageid}').val();
	if(kw) {
		$('#list-{$js_pageid}').show();
		$('#city-{$js_pageid}').hide();
		var res = '';
		var j = 0;
		$('#city-{$js_pageid} li').each(function(i){
			if($(this).text().indexOf(kw) !=-1) {
				var d = $(this).html();
				if(j++ == 0) {
					d = d.replace('<div onclick', '<div style="border:none;" onclick');
				} else {
					d = d.replace('<div style="border:none;"', '<div');
				}
				d = d.replace(kw, '<b class="f_red">'+kw+'</b>');
				res += '<li>'+d+'</li>';
			}
		});
		if(res == '') res = '<li onclick="Dr();"><div style="border:none;">未找到<b class="f_red">'+kw+'</b></div></li>';
		res = '<div style="padding:10px 16px;font-size:16px;" onclick="Dr();"><span style="float:right;color:#007AFF;">取消</span>搜索结果</div><div class="list-set"><ul>'+res+'</ul></div>';
		$('#list-{$js_pageid}').html(res);
	} else {
		$('#list-{$js_pageid}').hide();
		$('#list-{$js_pageid}').html('');
		$('#city-{$js_pageid}').show();
	}
}
function Dr() {
	$('#kw-{$js_pageid}').val('');
	Ds();
}
function Dc(id) {
	$.get('?areaid='+id+'&reload='+Math.random(), function(data) {
		if(data == 'ok') {
			Dtoast('{$js_pageid}','切换成功');
			setTimeout(function() {
				window.location.reload();
			}, 1000);
		} else if(data.indexOf('://') != -1) {
			Dtoast('{$js_pageid}','切换成功');
			setTimeout(function() {
				Go(data);
			}, 1000);
		} else {
			Dtoast('{$js_pageid}','切换失败');
		}
	});
}
</script>
{template 'footer'}