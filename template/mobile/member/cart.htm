{template 'header', 'member'}
{load('cart.css')}
{if $action == 'result'}
<div id="head-bar">
<div class="head-bar">
<div class="head-bar-back"><a href="{if $back_link}{$back_link}{else}javascript:Dback();" id="back-{$js_pageid}{/if}" data-direction="reverse"><img src="{DM_SKIN}icon-back{$wh}.png" width="24" height="24"/></a></div>
<div class="head-bar-title">加入购物车</div>
<div class="head-bar-right"><a href="?mid={$mid}"><img src="{DM_SKIN}icon-cart{$wh}.png" width="24" height="24"/></a></div>
</div>
<div class="head-bar-fix" id="load-fix-{$js_pageid}" style="height:0;"></div>
<div class="head-bar-fix" id="head-fix-{$js_pageid}"></div>
</div>
{if $code < 10}
<div class="ui-ok">
	<p>商品已成功加入购物车！ </p>
	<input type="button" value="立即结算" class="btn-green" onclick="Go('?mid={$mid}');"/>
	<input type="button" value="返回商品" class="btn" onclick="Go('{$url}');"/>
</div>
{else}
<div class="ui-ko">
	<p>
		{if $code == 10}
		商品不存在
		{elseif $code == 11}
		商家不存在
		{elseif $code == 12}
		不能下单自己的商品
		{elseif $code == 13}
		商品未上架
		{elseif $code == 14}
		商品库存不足
		{elseif $code == 15}
		商品价格错误
		{else}
		订单提交失败
		{/if}
	</p>
	<input type="button" value="重新挑选" class="btn-green" onclick="Go('{$MOD[mobile]}');"/>
	{if $itemid}
	<input type="button" value="查看商品" class="btn" onclick="Go('{$url}');"/>
	{else}
	<input type="button" value="返回购物车" class="btn" onclick="Go('cart.php?mid={$mid}');"/>
	{/if}
</div>
{/if}
{else}
<div id="head-bar">
<div class="head-bar">
<div class="head-bar-back"><a href="{if $back_link}{$back_link}{else}javascript:Dback();" id="back-{$js_pageid}{/if}" data-direction="reverse"><img src="{DM_SKIN}icon-back{$wh}.png" width="24" height="24"/></a></div>
<div class="head-bar-title">{$head_name}</div>
<div class="head-bar-right"><a href="javascript:Dpop('{$js_pageid}');"><img src="{DM_SKIN}icon-sheet{$wh}.png" width="24" height="24"/></a></div>
</div>
<div class="head-bar-fix" id="load-fix-{$js_pageid}" style="height:0;"></div>
<div class="head-bar-fix" id="head-fix-{$js_pageid}"></div>
</div>

<div class="ui-pop" id="pop-{$js_pageid}">
<i></i>
<div>
{if $lists}
<a href="javascript:;" onclick="move_muti(0);">删除选中</a>
<a href="javascript:;" onclick="move_muti(1);">移入收藏</a>
<a href="javascript:;" onclick="move_muti(2);">清空商品</a>
{else}
<a href="{$MODULE[2][mobile]}favorite.php?mid={$mid}" rel="external">商品关注</a>
{/if}
<a href="{$MODULE[2][mobile]}order.php?mid={$mid}" rel="external">我的订单</a>
<a href="{$MODULE[$mid][mobile]}" data-transition="none">返回{$MODULE[$mid][name]}</a>
</div>
</div>

{if $lists}
<form method="post" action="buy.php" onsubmit="return Mcheck();">
<input type="hidden" name="from" value="cart"/>
<input type="hidden" name="mid" value="{$mid}"/>
{loop $lists $tags}
{loop $tags $i $t}
{if $i == 0}
<div class="list-seller bd-t bd-b">
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td class="c1"><section><label><input type="checkbox" checked="checked" id="check-{$t[username]}" onclick="Ccheck('{$t[username]}');calculate();" data-check="{$t[username]}"/><i></i></label></section></td>
<td><div><a href="{userurl($t[username])}">{$t[company]}</a></div></td>
<td class="c3">
	{php $promos = get_promos($t[username]);}
	{if $promos}
	<a href="{$MODULE[2][mobile]}coupon.php?username={$t[username]}"><span>优惠券</span></a>
	{/if}
	<s id="total-{$t[username]}" data-user="{$t[username]}">0.00</s>
</td>
</tr>
</table>
</div>
{/if}
<input type="hidden" id="a1_{$t[key]}" value="{$t[a1]}"/>
<input type="hidden" id="a2_{$t[key]}" value="{$t[a2]}"/>
<input type="hidden" id="a3_{$t[key]}" value="{$t[a3]}"/>
<input type="hidden" id="p1_{$t[key]}" value="{$t[p1]}"/>
<input type="hidden" id="p2_{$t[key]}" value="{$t[p2]}"/>
<input type="hidden" id="p3_{$t[key]}" value="{$t[p3]}"/>
<input type="hidden" id="amount_{$t[key]}" value="{$t[amount]}"/>
<input type="hidden" id="mina_{$t[key]}" value="{$t[mina]}"/>
<input type="hidden" id="maxa_{$t[key]}" value="{$t[maxa]}"/>
<input type="hidden" id="unit_{$t[key]}" value="{$t[unit]}"/>
<div class="list-goods bd-b">
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td class="c1"><section><label><input type="checkbox" name="cart[]" value="{$t[key]}"{if $t[valid]} checked="checked" onclick="calculate()"{else}disabled{/if} id="check_{$t[key]}" data-check="{$t[username]}"/><i></i></label></section></td>
<td class="c2"><a href="{$t[mobile]}"><img src="{if $t[thumb]}{$t[thumb]}{else}{DM_SKIN}60x60.png{/if}" width="60" height="60" alt="" onerror="this.src='{DM_SKIN}60x60.png';"/></a></td>
<td>
	<p><a href="{$t[mobile]}" class="b">{$t[title]}</a></p>
	<b>{if $t[m1]}{$t[n1]}:{$t[m1]}&nbsp;{/if}{if $t[m2]}{$t[n2]}:{$t[m2]}&nbsp;{/if}{if $t[m3]}{$t[n3]}:{$t[m3]}&nbsp;{/if}</b>
	<div>
	<table cellpadding="0" cellspacing="0" width="100%">
	<tr>
	<td><em>{$DT[money_sign]}<span id="price_{$t[key]}">{$t[price]}</span>{if isset($t[unit]) && $t[unit]}/{$t[unit]}{/if}</em></td>
	<td class="a1" onclick="alter('{$t[key]}', '-', {$t[mina]}, {$t[maxa]});">-</td>
	<td class="a2">{if $t[valid]}<input type="tel" name="amounts[{$t[key]}]" value="{$t[a]}" id="number_{$t[key]}" onblur="calculate();"/>{else}失效{/if}</td>
	<td class="a3" onclick="alter('{$t[key]}', '+', {$t[mina]}, {$t[maxa]});">+</td>
	</tr>
	</table>
	</div>
	<s id="total_{$t[key]}" total-{$t[username]}="1">{$t[price]}</s>
</td>
</tr>
</table>
</div>
{/loop}
{/loop}
<div class="cart-foot-fix"></div>
<div class="cart-foot">
<table cellpadding="0" cellspacing="0" width="100%">
<tr>
<td class="c1"><section><label><input type="checkbox" checked="checked" id="check-all" onclick="Ccheck();calculate();"/><i></i></label></section></td>
<td class="c2"><p>共 <b id="total_good"></b> 件，计 <b>{$DT[money_sign]}</b><b id="total_amount"></b></p></td>
<td class="c3"><input type="submit" value="结算"/></td>
</tr>
</table>
</div>
</form>
{else}
<div class="cart-msg">
{if $action == 'guest'}
您还没有登录，请先登录或注册
<div class="blank-32"></div>
<div class="blank-32"></div>
<a href="{$DT[file_login]}"><div class="btn-green">立即登录</div></a>
<div class="blank-32"></div>
<a href="{$DT[file_register]}"><div class="btn">注册会员</div></a>
{elseif $action == 'close'}
购物车功能未开放
{else}
您的购物车还是空的，赶快行动吧！马上去
<div class="blank-32"></div>
<div class="blank-32"></div>
<a href="{$MOD[mobile]}"><div class="btn-green">挑选商品</div></a>
{/if}
</div>
{/if}
{/if}
<script type="text/javascript">
function Ccheck(key) {
	$(key ? '[data-check="'+key+'"]' : '[data-check]').each(function(){
		$(this).prop('checked', $('#check-'+(key ? key : 'all')).prop('checked') ? true : false);
	});
}
function Mcheck() {
	if(Dd('total_good').innerHTML == '0') {
		Dtoast('{$js_pageid}', '最少需要挑选1件商品');
		window.scroll(0, 0);
		return false;
	}
    return true;
}
function move_muti(i) {
	if(i == 2) {
		if(confirm('确定要清空购物车吗？')) {
			Go('?mid={$mid}&action=clear');
		}
		return;
	} else {
		if(Dd('total_good').innerHTML == '0') {
			Dtoast('{$js_pageid}', '未选择商品');
			return;
		}
		if(confirm(i ? '确定要将选中商品移入收藏吗？' : '确定要删除选中商品吗？')) {
			var par = 'action=delete&mid={$mid}&ajax=1&fav='+i;
			$(':checked').each(function(i) {
				if($(this).attr('id').indexOf('check_') != -1) {
					par += '&key[]='+$(this).val();
				}
			});		
			$.post('?', par, function(data) {
				Go('?mid={$mid}&rand={$DT_TIME}');
			});
		}
	}
}
function move(i) {
	Dd('check_'+i).checked = false;
	Dd('check_'+i).disabled = true;
	Dh('tr_'+i);
	calculate();
	$.post('?', 'action=delete&mid={$mid}&ajax=1&key='+i, function(data) {
		var cart_num = get_cart();
		$('#destoon_cart').html(cart_num > 0 ? '<strong>'+cart_num+'</strong>' : '0');
		if(data == 1 && Dd('total_good').innerHTML == '0') Go('?mid={$mid}&rand={$DT_TIME}');
	});
}
function alter(i, t, mina, maxa) {
	if(t == '+') {
		if(maxa && Dd('number_'+i).value >= maxa) {Dtoast('{$js_pageid}', '最多购买'+maxa+Dd('unit_'+i).value);return;}
		Dd('number_'+i).value =  parseInt(Dd('number_'+i).value) + 1;
	} else {
		if(Dd('number_'+i).value <= mina) {Dtoast('{$js_pageid}', '最少购买'+mina+Dd('unit_'+i).value);return;}
		Dd('number_'+i).value = parseInt(Dd('number_'+i).value) - 1;
	}
	calculate();
}
function get_price(i) {
	if(Dd('a2_'+i).value > 0) {
		if(Dd('a3_'+i).value > 1 && parseInt(Dd('number_'+i).value) > parseInt(Dd('a3_'+i).value)) return Dd('p3_'+i).value;
		if(Dd('a2_'+i).value > 1 && parseInt(Dd('number_'+i).value) > parseInt(Dd('a2_'+i).value)) return Dd('p2_'+i).value;
		return Dd('p1_'+i).value;
	}
	return Dd('p1_'+i).value
}
function calculate() {
	var _good = _amount = _total = 0;
	$(':checked').each(function(i) {
		if($(this).attr('id').indexOf('check_') != -1) {
			var key = $(this).val();
			var num, good, maxa, mina, price;
			num = parseInt(Dd('number_'+key).value);
			maxa = parseInt(Dd('maxa_'+key).value);
			mina = parseInt(Dd('mina_'+key).value);
			if(num < mina) Dd('number_'+key).value = num = mina;
			if(num > maxa) Dd('number_'+key).value = num = maxa;
			if(isNaN(num) || num < 0) Dd('number_'+key).value = num = mina;
			_good++;
			price = parseFloat(get_price(key));
			_total = price*num;
			_amount += _total;
			Dd('price_'+key).innerHTML = price.toFixed(2);
			Dd('total_'+key).innerHTML = _total.toFixed(2);
		}
	});
	Dd('total_good').innerHTML = _good;
	Dd('total_amount').innerHTML = _amount.toFixed(2);
	$('[data-user]').each(function() {
		var user = $(this).attr('data-user');
		var tt = 0;
		$('[total-'+user+']').each(function() {
			tt += parseFloat($(this).html());
		});
		$(this).html(tt.toFixed(2));
	});
}
{if $lists}$(function(){calculate();});{/if}
</script>
{template 'footer', 'member'}
