<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备型号选择器</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        select, button { padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        select { width: 100%; }
        button { background: #007cba; color: white; border: none; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #result { margin-top: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 4px; }
        .loading { color: #666; }
        .error { color: red; background: #fee; padding: 10px; border-radius: 4px; }
        .success { color: green; background: #efe; padding: 10px; border-radius: 4px; }
        option:disabled { color: #999; background: #f5f5f5; }
        .device-info { margin-top: 15px; }
        .device-info p { margin: 8px 0; }
        .device-info strong { display: inline-block; width: 80px; }
    </style>
</head>
<body>
    <div class="device-selector">
        <h1>设备型号选择器</h1>
        
        <div class="form-group">
            <label for="category">设备类别:</label>
            <select id="category" name="category">
                <option value="">请选择设备类别</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="model">设备型号:</label>
            <select id="model" name="model" disabled>
                <option value="">请先选择设备类别</option>
            </select>
        </div>
        
        <button id="submit-btn" type="button" disabled>查询设备信息</button>
    </div>

    <div id="result"></div>

    <script>
        const API_BASE = '/api/';
        const DEVICE_DATA_API = API_BASE + 'get_device_data.php';
        const DEVICE_DETAIL_API = API_BASE + 'get_device_detail.php';

        let deviceData = [];

        // 加载设备数据
        async function loadDeviceData() {
            try {
                const response = await fetch(DEVICE_DATA_API);
                const result = await response.json();
                
                if (result.success && result.data) {
                    deviceData = result.data;
                    initCategorySelect();
                } else {
                    throw new Error(result.message || '数据加载失败');
                }
            } catch (error) {
                console.error('加载设备数据失败:', error);
                alert('设备数据加载失败，请刷新页面');
            }
        }

        // 初始化类别下拉框
        function initCategorySelect() {
            const categorySelect = document.getElementById('category');
            
            deviceData.forEach(item => {
                const option = document.createElement('option');
                option.value = item[0];
                option.textContent = item[0];
                categorySelect.appendChild(option);
            });
        }

        // 更新型号下拉框
        function updateModelSelect(categoryValue) {
            const modelSelect = document.getElementById('model');
            const submitBtn = document.getElementById('submit-btn');
            
            modelSelect.innerHTML = '';
            modelSelect.disabled = true;
            submitBtn.disabled = true;
            
            if (!categoryValue) {
                modelSelect.innerHTML = '<option value="">请先选择设备类别</option>';
                return;
            }
            
            const category = deviceData.find(item => item[0] === categoryValue);
            if (!category) return;
            
            const models = category[1];
            
            // 添加默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '请选择设备型号';
            modelSelect.appendChild(defaultOption);
            
            // 添加分组和型号
            models.forEach(modelGroup => {
                // 分组标题（灰色不可选）
                const groupOption = document.createElement('option');
                groupOption.value = '';
                groupOption.textContent = `--- ${modelGroup[0]} ---`;
                groupOption.disabled = true;
                modelSelect.appendChild(groupOption);
                
                // 具体型号（可选）
                modelGroup[1].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            });
            
            modelSelect.disabled = false;
        }

        // 提交查询
        async function submitQuery() {
            const category = document.getElementById('category').value;
            const model = document.getElementById('model').value;
            const resultDiv = document.getElementById('result');
            
            if (!category || !model) {
                alert('请选择完整的设备信息');
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">查询中...</div>';
            
            try {
                const response = await fetch(DEVICE_DETAIL_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `category=${encodeURIComponent(category)}&model=${encodeURIComponent(model)}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResult(result.data);
                } else {
                    resultDiv.innerHTML = `<div class="error">${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">网络错误，请重试</div>';
            }
        }

        // 显示查询结果
        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            
            let html = `
                <div class="success">查询成功</div>
                <div class="device-info">
                    <p><strong>设备名称:</strong> ${data.ming || '暂无'}</p>
                    <p><strong>设备型号:</strong> ${data.xinghao || '暂无'}</p>
                    <p><strong>价格:</strong> ${data.jiage || '暂无'}</p>
                    <p><strong>库存:</strong> ${data.kucun || '暂无'}</p>
                    <p><strong>描述:</strong> ${data.miaoshu || '暂无描述'}</p>
                    <p><strong>分类:</strong> ${data.catname || '暂无'}</p>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // 事件监听
        document.addEventListener('DOMContentLoaded', function() {
            loadDeviceData();
            
            document.getElementById('category').addEventListener('change', function() {
                updateModelSelect(this.value);
            });
            
            document.getElementById('model').addEventListener('change', function() {
                document.getElementById('submit-btn').disabled = !this.value;
            });
            
            document.getElementById('submit-btn').addEventListener('click', submitQuery);
        });
    </script>
</body>
</html>